
@{
    ViewBag.Title = "Calendar";
}

<h2>Chat</h2>

<div class="container">
    <input type="text" id="message" />
    <input type="button" id="sendmessage" value="Send" />
    <input type="hidden" id="displayname" />
    <ul id="discussion"></ul>
</div>

<div id="calendar"></div>

@section scripts {
    <script src="~/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <script src="~/signalr/hubs"></script>
    <link rel='stylesheet' href="~/Content/fullcalendar.css" />
    <script src="~/Scripts/moment.min.js"></script>
    <script src="~/Scripts/fullcalendar.js"></script>
    <script>
        $(function () {

            var hub = $.connection.calendarHub;
            var split = document.URL.split('/');
            var id = split[split.length - 1];
            $.connection.hub.qs = "id=" + id;

            $.connection.hub.start().done(function () {
                hub.server.joinGroup(id);
                calendar = new FullCalendar('calendar', hub);
            });

            hub.client.addEvent = function (id, start, end) {
                var event = {
                    id: id,
                    title: '',
                    start: start,
                    end: end,
                    other: true
                };
                calendar.renderEvent(event);
            };
            hub.client.removeEvent = function (id) {
                calendar.removeEvent(id);
                calendar.rerenderEvents();
            }
        });


    </script>

    <script>
        function newGuid() {
            var d = new Date().getTime();
            var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                var r = (d + Math.random() * 16) % 16 | 0;
                d = Math.floor(d / 16);
                return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
            return uuid;
        }

        var calendar;
        function initialiseCalendar(hub) {
        };

        function FullCalendar(id, hub) {
            var self = this;
            self.element = $('#' + id);

            self.getEvents = function(){
                return self.element.fullCalendar('clientEvents');
            };

            self.renderEvent = function (event) {
                self.element.fullCalendar('renderEvent', event);
            };

            self.removeEvent = function (id) {
                var el = $('.fc-event').filter(function () {
                    return $(this).attr('fc-id') == id
                });
                el.css('color', 'red');
                el.parent().remove()
                self.element.fullCalendar('removeEvents', id);
            };

            self.rerenderEvents = function () {
                self.element.fullCalendar('rerenderEvents');
            }

            $(document).ready(function () {

                self.element.fullCalendar({
                    header: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'month,agendaWeek,agendaDay'
                    },
                    defaultDate: '2015-02-12',
                    editable: true,
                    eventLimit: true, // allow "more" link when too many events
                    events: function (start, end, timezone, callback) {
                        callback(
                            [
                                {
                                    title: 'All Day Event',
                                    start: '2015-02-01'
                                },
                                {
                                    title: 'Long Event',
                                    start: '2015-02-07',
                                    end: '2015-02-10',
                                    rendering: 'background'
                                }
                            ]);
                    },
                    selectable: true,
                    selectHelper: true,
                    eventClick: function (event, jsEvent, view) {
                        hub.server.removeEvent(event.id);
                        self.removeEvent(event.id);
                    },
                    eventDestroy: function (event, element, view) {

                    },
                    eventRender: function (event, element, view) {
                        element.attr('fc-id', event.id);
                        if (event.other) {
                            element.css('background-color', 'red');
                        }
                    },
                    //dayClick: function (date, jsEvent, view) {
                    //    $(this).css('background-color', 'red');
                    //}
                    eventAfterAllRender: function(){
                        var events = self.getEvents();
                    },
                    select: function (start, end, jsEvent) {
                        if (jsEvent) {
                            var event = {
                                id: newGuid(),
                                title: '',
                                start: start,
                                end: end
                            };
                            hub.server.addEvent(event.id, event.start, event.end);
                            self.renderEvent(event);
                        }
                    },
                });
            });
        }
    </script>
}
